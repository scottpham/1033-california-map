<html>
<head>
<title></title>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="//d3js.org/colorbrewer.v1.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>

<style>

.subunit.San.Francisco,
.subunit.mateo,
.subunit.alameda,
.subunit.santa.clara {
}

.subunit {
	fill: steelblue;
	stroke: white;
	stroke-width: 1px;
}

.subunit:hover {
	opacity: 0.7;
	fill: lightyellow;

}

.exterior-boundary {
	fill: none;
	stroke: black;
	stroke-linejoin: round;
	stroke-width: 2px;
}

div.tooltip {
	position: absolute;
	text-align: center;
	width: 100px;
	padding: 2px;
	font: 12px sans-serif;
	color: white;
	background: black;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
}

.key {
	/*stroke: black;*/
}

.legend {
	font-size: 9px;
}


</style>

</head>
<body>
	<h1>Choropleth of Foreign-Born By County</h1>
	<div id = "map"></div>

<script>

	var width = 650,
		height = 600;

	var  projection = d3.geo.mercator()
		.scale(1000 * 2)
		.center([-120, 36])
		.translate([width/4, height/2]);

	var path = d3.geo.path()
		.projection(projection);

	var svg = d3.select("#map").append("svg")
		.attr("width", width)
		.attr("height", height);

	//global for console
	var myObj = {};

	var peopleMax = 3473925;
	//function to assign colors to data
	var color = d3.scale.quantile() //colorscale
		.domain([1, peopleMax])
		.range(colorbrewer.RdGy[9]);

	//format
	var format = d3.format(",.2r");

	d3.json("ca-counties-topo.json", function(error, ca){
		
		d3.csv("census.csv", function (error, data) {
			var rateById = {};

			data.forEach(function(d) { 
				rateById[d.geoid] = +d.total;})

			myObj = topojson.feature(ca, ca.objects.caCounties);
			console.log("myObj is available");

			svg.append("path")
				.datum(topojson.feature(ca, ca.objects.caCounties))
				.attr("class", "land")
				.attr("d", path);

			//bind feature data to the map
			svg.selectAll(".subunit")
				  .data(topojson.feature(ca, ca.objects.caCounties).features)
				.enter().append("path")
				.attr("class", function(d) { return "subunit " + d.properties.name; })
				.attr("d", path)
				  //get color from csv call
				  .style("fill", function(d){ return color(rateById[d.id]);
				  })
				.on("mouseover", function(d){ //tooltip
					div.transition()
						.duration(200)
						.style("opacity", .9);
					div.html(d.properties.fullName + "<p>" + "Foreign Born: " + format(rateById[d.id]))//warning this is an approximation
						.style("left", (d3.event.pageX) + 10 + "px")
						.style("top", (d3.event.pageY - 30) + "px"); 
				})
				.on("mouseout", function(d) { 
					div.transition()
						.duration(500)
						.style("opacity", 0.0);
				});

			//exterior border
			svg.append("path")
				.datum(topojson.mesh(ca, ca.objects.caCounties, function(a, b) { return a === b;}))
				.attr("d", path)
				.attr("class", "exterior-boundary");

			//tooltip declaration
			var div = d3.select("#map").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);

		});	
	});

	//key position encoding
	var y = d3.scale.linear()
		.domain([0, peopleMax]) //input data
		.range([0, 100]); //height of the key

	var colorBar = svg.append("g")
		.attr("class", "key")
		.attr("transform", "translate(" + (.3 * width) + "," + (.05 * height) + ")")
		.selectAll("rect")
		.data(color.range().map(function(col) {
			var d = color.invertExtent(col);
			return d;
		}));

	colorBar.enter()
		.append("rect")
			.attr("width", 10)
			.attr("y", function(d) { return y(d[0]); })
			.attr("height", function(d) { return y(d[1]) - y(d[0]); })
			.attr("fill", function(d) { return color(d[0]); });

	//labels
	colorBar.enter().append('text')
		.attr("class", "legend")
		.attr("y", function(d, i) {
			return y(d[1]) - 3; })
		.attr("x", 12)
		.text(function(d,i) { 
			if (i === 0 | i === 4 | i === 8) return format(d[1]) + " people."; }); 

</script>

</body>
</html>
